# meson-minimal-ti-c28x-cgt

> Minimal example of a TI C28x CGT cross build with Meson to demonstrate issues.

This minimal example of a Meson cross build using TI's C28x C2000 Code
Generation Tools demonstrates that the Ninja backend geenrates the compile and
linker with the arguments in the wrong order and omits required compiler
arguments from the linker command precending the argument to run the linker.

Meson version: 1.5.1  
Ninja version: 1.11.1.1

## Prerequisties

1. Have Docker installed.

## Steps to reproduce

1. Clone this repo.

2. Run the `build-example.sh` script.

The script will run the build in a Docker container made from an image hosted in
the GitHub Container Repository that provides the build environment needed for
building TI C28x C2000 embedded software. The sources for the image can be found
in the `docker` directory in this repo.

A response like this should be received. The warnings at the end of the output
are caused by the lack of the compiler arguments being included in the linker
command generated by the Ninja backend. The incorrect order of arguments
in both the compile and link commands is shown, as well.  

```text
‚ùØ ./build-example.sh
The Meson build system
Version: 1.5.1
Source dir: /repo
Build dir: /repo/builddir
Build type: cross build
Project name: minimal-ti-c28x-cgt-f2837xd
Project version: 0.1.0
C compiler for the host machine: cl2000 (c2000 22.6.1 "TMS320C2000 C/C++ Compiler              v22.6.1.LTS")
C linker for the host machine: cl2000 cl2000 22.6.1
C compiler for the build machine: cc (gcc 11.4.0 "cc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0")
C linker for the build machine: cc ld.bfd 2.38
Build machine cpu family: x86_64
Build machine cpu: x86_64
Host machine cpu family: c2000
Host machine cpu: c28x
Target machine cpu family: c2000
Target machine cpu: c28x
Build targets in project: 1

minimal-ti-c28x-cgt-f2837xd 0.1.0

  User defined options
    Cross files: c2000.txt

Found ninja-1.11.1.git.kitware.jobserver-1 at /usr/local/bin/ninja
INFO: autodetecting backend as ninja
INFO: calculating backend command to run: /usr/local/bin/ninja -C /repo/builddir -v
ninja: Entering directory `/repo/builddir'
[1/3] cl2000 -I=minimal-ti-c28x-cgt-f2837xd.out.p -I=. -I=.. -I=/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --c99 -O2 '--define=RELEASE -DNDEBUG' -v28 -ml -mt --cla_support=cla1 --float_support=fpu32 --tmu_support=tmu0 --vcu_support=vcu2 --diag_suppress=10063 --diag_warning=225 --diag_wrap=off --display_error_number --abi=eabi --define=F2837xD --define=CPU1 --preproc_with_compile --preproc_dependency=minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o.d --output_file=minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o ../src/F2837xD_CodeStartBranch.asm
[2/3] cl2000 -I=minimal-ti-c28x-cgt-f2837xd.out.p -I=. -I=.. -I=/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --c99 -O2 '--define=RELEASE -DNDEBUG' -v28 -ml -mt --cla_support=cla1 --float_support=fpu32 --tmu_support=tmu0 --vcu_support=vcu2 --diag_suppress=10063 --diag_warning=225 --diag_wrap=off --display_error_number --abi=eabi --define=F2837xD --define=CPU1 --preproc_with_compile --preproc_dependency=minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o.d --output_file=minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o ../src/main.c
[3/3] cl2000  -z --output_file=minimal-ti-c28x-cgt-f2837xd.out minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o /repo/2837xD_RAM_lnk_cpu1.cmd -mminimal-ti-c28x-cgt-f2837xd.map --heap_size=0x200 --stack_size=0x3F8 --warn_sections -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/lib -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --reread_libs --define=RAM --diag_wrap=off --display_error_number --xml_link_info=minimal_ti_c28x_cgt_f2837xd_linkInfo.xml --rom_model -llibc.a
<Linking>
warning #10440-D: creating output section ".bss" without a SECTIONS specification.  For additional information on this section, please see the 'C2000 Migration from COFF to EABI' guide at https://software-dl.ti.com/ccs/esd/documents/C2000_c28x_migration_from_coff_to_eabi.html
warning #10440-D: creating output section ".const" without a SECTIONS specification.  For additional information on this section, please see the 'C2000 Migration from COFF to EABI' guide at https://software-dl.ti.com/ccs/esd/documents/C2000_c28x_migration_from_coff_to_eabi.html
warning #10440-D: creating output section ".sysmem" without a SECTIONS specification.  For additional information on this section, please see the 'C2000 Migration from COFF to EABI' guide at https://software-dl.ti.com/ccs/esd/documents/C2000_c28x_migration_from_coff_to_eabi.html
warning #10440-D: creating output section ".init_array" without a SECTIONS specification.  For additional information on this section, please see the 'C2000 Migration from COFF to EABI' guide at https://software-dl.ti.com/ccs/esd/documents/C2000_c28x_migration_from_coff_to_eabi.html
warning #10247-D: creating output section ".data" without a SECTIONS specification
```

## Cause of the warnings

The linker scripts provided by TI use macros to conditionally include the
correct elements for the ABI that is set by an argument provided to the code gen
tools.

In order to include the correct linker script elements for the current
ABI specified by TI, EABI, the argument `--abi=eabi` must be passed to the code
gen tools when compiling *and* linking.

The argument must come before the
argument that tells the code gen tools to run the linker, `-z` or `--run_linker`
but that is impossible since the compiler arguments are not included in the
command generated by the Ninja backend.

The warnings are caused by this section of the linker script. The macro
`__TI_EABI__` is set by the code gen tools when the `--abi=eabi` argument is
passed with the compiler arguments before the `-z` or `--run_linker` argument
but that doesn't happen because the linker command does not include any of the
compiler arguments.

`2837xD_RAM_lnk_cpu1.cmd`
```
SECTIONS
{
   codestart        : > BEGIN,     PAGE = 0
   .text            : >> RAMD0 |  RAMLS0 | RAMLS1 | RAMLS2 | RAMLS3 | RAMLS4,   PAGE = 0
   .cinit           : > RAMM0,     PAGE = 0
   .switch          : > RAMM0,     PAGE = 0
   .reset           : > RESET,     PAGE = 0, TYPE = DSECT /* not used, */
   .stack           : > RAMM1,     PAGE = 1

#if defined(__TI_EABI__)
   .bss             : > RAMLS5,    PAGE = 1
   .bss:output      : > RAMLS3,    PAGE = 0
   .init_array      : > RAMM0,     PAGE = 0
   .const           : > RAMLS5,    PAGE = 1
   .data            : > RAMLS5,    PAGE = 1
   .sysmem          : > RAMLS5,    PAGE = 1
#else
   .pinit           : > RAMM0,     PAGE = 0
   .ebss            : > RAMLS5,    PAGE = 1
   .econst          : > RAMLS5,    PAGE = 1
   .esysmem         : > RAMLS5,    PAGE = 1
#endif

...
```

The Ninja build rule does include `$ARGS` in the correct place but, as is shown
by the output, the compiler arguments are still not included.

builddir/build.ninja

```
...

rule c_LINKER
 command = cl2000 $ARGS -z --output_file=$out $in $LINK_ARGS
 description = Linking target $out

...
```

The compiler arguments that contain `--abi=eabi` should be included before `-z`
but they are not.

```
[3/3] cl2000  -z --output_file=minimal-ti-c28x-cgt-f2837xd.out minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o /repo/2837xD_RAM_lnk_cpu1.cmd -mminimal-ti-c28x-cgt-f2837xd.map --heap_size=0x200 --stack_size=0x3F8 --warn_sections -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/lib -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --reread_libs --define=RAM --diag_wrap=off --display_error_number --xml_link_info=minimal_ti_c28x_cgt_f2837xd_linkInfo.xml --rom_model -llibc.a
```

This linker command also shows that the input files and the linker arguments are
in the wrong order.

The order of the arguments is specified in the TI docs for the compilers.

C2000-CGT specification from section 2.2 of the
[manual](https://www.ti.com/lit/ug/spru514z/spru514z.pdf):

```text
cl2000 [options] [filenames] [--run_linker [link_options] object files]]
```

The command generated includes the object files before the link_options.

Output arguments: `--output_file=minimal-ti-c28x-cgt-f2837xd.out`

Input files: `minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o /repo/2837xD_RAM_lnk_cpu1.cmd`

Linker args: `-mminimal-ti-c28x-cgt-f2837xd.map --heap_size=0x200 --stack_size=0x3F8 --warn_sections -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/lib -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --reread_libs --define=RAM --diag_wrap=off --display_error_number --xml_link_info=minimal_ti_c28x_cgt_f2837xd_linkInfo.xml --rom_model -llibc.a`

Compiler args: missing, should precede `-z`

```
[3/3] cl2000  -z --output_file=minimal-ti-c28x-cgt-f2837xd.out minimal-ti-c28x-cgt-f2837xd.out.p/src_main.c.o minimal-ti-c28x-cgt-f2837xd.out.p/src_F2837xD_CodeStartBranch.asm.o /repo/2837xD_RAM_lnk_cpu1.cmd -mminimal-ti-c28x-cgt-f2837xd.map --heap_size=0x200 --stack_size=0x3F8 --warn_sections -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/lib -i/root/ti/cgt/ti-cgt-c2000_22.6.1.LTS/include --reread_libs --define=RAM --diag_wrap=off --display_error_number --xml_link_info=minimal_ti_c28x_cgt_f2837xd_linkInfo.xml --rom_model -llibc.a
```

This is apparent in the Ninja build file above, as well. The linker rule ends
with `$in $LINK_ARGS` but it should be `$LINK_ARGS $in`.
